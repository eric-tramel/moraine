#!/usr/bin/env bash
set -euo pipefail

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
CONFIG_PATH="${CORTEX_CONFIG:-$HOME/.cortex/config.toml}"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --config)
      CONFIG_PATH="$2"
      shift 2
      ;;
    *)
      echo "unknown argument: $1" >&2
      exit 2
      ;;
  esac
done

if [[ ! -f "$CONFIG_PATH" ]]; then
  mkdir -p "$(dirname "$CONFIG_PATH")"
  cp "$PROJECT_ROOT/config/cortex.toml" "$CONFIG_PATH"
fi

toml_get() {
  local section="$1"
  local key="$2"
  local file="$3"
  awk -v section="$section" -v key="$key" '
    BEGIN { in_section = 0 }

    /^[[:space:]]*#/ { next }

    $0 ~ "^[[:space:]]*\\[" section "\\][[:space:]]*$" {
      in_section = 1
      next
    }

    $0 ~ "^[[:space:]]*\\[[^]]+\\][[:space:]]*$" {
      in_section = 0
    }

    in_section && $0 ~ "^[[:space:]]*" key "[[:space:]]*=" {
      value = $0
      sub(/^[^=]*=[[:space:]]*/, "", value)
      sub(/[[:space:]]+#.*$/, "", value)
      gsub(/^"/, "", value)
      gsub(/"$/, "", value)
      print value
      exit
    }
  ' "$file"
}

CLICKHOUSE_URL="$(toml_get "clickhouse" "url" "$CONFIG_PATH")"
CLICKHOUSE_DB="$(toml_get "clickhouse" "database" "$CONFIG_PATH")"
CLICKHOUSE_URL="${CLICKHOUSE_URL:-http://127.0.0.1:8123}"
CLICKHOUSE_DB="${CLICKHOUSE_DB:-cortex}"

if ! curl -fsS "$CLICKHOUSE_URL/?query=SELECT%201" >/dev/null 2>&1; then
  echo "clickhouse is unavailable at $CLICKHOUSE_URL" >&2
  exit 1
fi

"$PROJECT_ROOT/bin/cortexctl" db migrate --config "$CONFIG_PATH"

run_sql() {
  local stmt="$1"
  curl -fsS --data-binary "$stmt" "$CLICKHOUSE_URL/?database=$CLICKHOUSE_DB" >/dev/null
}

echo "backfilling search index tables in $CLICKHOUSE_DB"

run_sql "TRUNCATE TABLE ${CLICKHOUSE_DB}.search_postings"
run_sql "TRUNCATE TABLE ${CLICKHOUSE_DB}.search_documents"

run_sql "INSERT INTO ${CLICKHOUSE_DB}.search_documents (doc_version, ingested_at, event_uid, compacted_parent_uid, session_id, session_date, source_name, provider, source_file, source_generation, source_line_no, source_offset, source_ref, record_ts, event_class, payload_type, actor_role, name, phase, text_content, payload_json, token_usage_json) SELECT event_version, ingested_at, event_uid, origin_event_id, session_id, session_date, source_name, provider, source_file, source_generation, source_line_no, source_offset, source_ref, record_ts, event_kind, payload_type, actor_kind, tool_name, if(tool_phase != '', tool_phase, op_status), text_content, payload_json, token_usage_json FROM ${CLICKHOUSE_DB}.events WHERE lengthUTF8(replaceRegexpAll(text_content, '\\\\s+', '')) > 0"

DOCS="$(curl -fsS "$CLICKHOUSE_URL/?query=SELECT%20count()%20FROM%20${CLICKHOUSE_DB}.search_documents")"
POSTINGS="$(curl -fsS "$CLICKHOUSE_URL/?query=SELECT%20count()%20FROM%20${CLICKHOUSE_DB}.search_postings")"
TERMS="$(curl -fsS "$CLICKHOUSE_URL/?query=SELECT%20count()%20FROM%20${CLICKHOUSE_DB}.search_term_stats")"
CORPUS_DOCS="$(curl -fsS "$CLICKHOUSE_URL/?query=SELECT%20sum(docs)%20FROM%20${CLICKHOUSE_DB}.search_corpus_stats")"

echo "search_documents: $DOCS"
echo "search_postings: $POSTINGS"
echo "search_term_stats (terms): $TERMS"
echo "search_corpus_stats (docs): $CORPUS_DOCS"
